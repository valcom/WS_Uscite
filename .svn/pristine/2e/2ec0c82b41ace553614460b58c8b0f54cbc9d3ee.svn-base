package it.ccse.uscite.domain;

import it.ccse.uscite.domain.SettoreAttivita.StatoAntimafia;
import it.ccse.uscite.domain.common.DomainEntity;
import it.ccse.uscite.domain.util.UsciteProperties;
import it.ccse.uscite.infrastructure.exception.ApplicationException;

import java.io.Serializable;

import javax.persistence.*;

import org.apache.commons.lang3.time.DateUtils;
import org.hibernate.envers.AuditTable;
import org.hibernate.envers.Audited;
import org.hibernate.envers.RelationTargetAuditMode;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.math.BigInteger;


/**
 * The persistent class for the pratica_erogazione database table.
 * 
 */
@Entity
@Table(name="pratica_erogazione")
@AttributeOverride(name = "id", column = @Column(name = "id_pratica_erogazione"))
@Audited
@AuditTable(value="pratica_erogazione")
public class PraticaErogazione extends DomainEntity<Integer> implements Serializable {
	private static final long serialVersionUID = 1L;

	private Integer anno;

	@Column(name="autorizzazione_autorizzante")
	private String autorizzazioneAutorizzante;

	@Column(name="autorizzazione_comitato")
	@Enumerated(EnumType.STRING)
	private AutorizzazioneComitato autorizzazioneComitato = AutorizzazioneComitato.UNDEFINED;

	@Column(name="autorizzazione_contabile",nullable = false)
	@Enumerated(EnumType.STRING)
	private AutorizzazioneContabile autorizzazioneContabile = AutorizzazioneContabile.UNDEFINED;

	@Column(name="autorizzazione_legale",nullable = false)
	@Enumerated(EnumType.STRING)
	private AutorizzazioneLegale autorizzazioneLegale = AutorizzazioneLegale.UNDEFINED;

	private String bimestre;

	@Column(name="codice_pratica")
	private String codicePratica;

	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_autorizzazione_comitato")
	private Date dataAutorizzazioneComitato;

	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_contabilizzazione")
	private Date dataContabilizzazione;

	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_erogazione")
	private Date dataErogazione;

	@Temporal(TemporalType.DATE)
	@Column(name="data_interessi")
	private Date dataInteressi;

	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_lavorazione")
	private Date dataLavorazione;

	@Deprecated
	@Temporal(TemporalType.DATE)
	@Column(name="data_regolazione")
	private Date dataRegolazione;
	
	@Temporal(TemporalType.DATE)
	@Column(name="data_scadenza")
	private Date dataScadenza;
	
	@Temporal(TemporalType.DATE)
	@Column(name="data_competenza_economica")
	private Date dataCompetenzaEconomica;

	private String descrizione;

	@Column(name="id_articolo_ac")
	private BigInteger idArticoloAc;

	@Column(name="id_autorizzante")
	private String idAutorizzante;

	@Column(name="id_capitolo_ac")
	private BigInteger idCapitoloAc;

	@Column(name="id_centro_costo")
	private String idCentroCosto;

	@Column(name="id_centro_responsabilita")
	private String idCentroResponsabilita;

	@Column(name="id_componente_tariffaria_ac")
	private BigInteger idComponenteTariffariaAc;

	@Column(name="id_conto_corrente_ac")
	private BigInteger idContoCorrenteAc;

	@Column(name="id_conto_gestione_ac")
	private BigInteger idContoGestioneAc;

	@Column(name="id_lavorante")
	private String idLavorante;

	@Column(name="id_posizione_finanziaria_ac")
	private BigInteger idPosizioneFinanziariaAc;
	
	@Column(name="codice_posizione_finanziaria")
	private String codicePosizioneFinanziaria;

	@Column(name="id_pratica_erogazione_differenza")
	private Integer idPraticaErogazioneDifferenza;

	@Column(name="id_pratica_erogazione_originale")
	private Integer idPraticaErogazioneOriginale;

	@Column(name="id_pratica_erogazione_rettifica")
	private Integer idPraticaErogazioneRettifica;

	@Column(name="id_proponente")
	private String idProponente;

	@Embedded
	@AttributeOverride(column = @Column(name="id_settore_attivita"), name = "id")
	private SettoreAttivita settoreAttivita;

	private BigDecimal impegno;

	@Column(name="lavorazione_contabile")
	@Enumerated(EnumType.STRING)
	private StatoPratica lavorazioneContabile = StatoPratica.UNDEFINED;

	private BigDecimal mandato;

	@Column(name="numero_rettifica")
	private Integer numeroRettifica;

	private Integer periodo;

	@Column(name="stato_pratica_gestionale")
	private String statoPraticaGestionale;

	@Column(name="stato_riepilogativo")
	private String statoRiepilogativo;

	private String tipologia;

	@Column(name="visto_conformita")
	private String vistoConformita;

	//uni-directional many-to-one association to TipoPeriodo
	@ManyToOne(optional = false)
	@JoinColumn(name="id_tipo_periodo")
	@Audited(targetAuditMode=RelationTargetAuditMode.NOT_AUDITED)
	private TipoPeriodo tipoPeriodo;

	private String owner;

	//bi-directional many-to-one association to ProcessoErogazione
	@ManyToOne(optional=true)
	@JoinColumn(name="id_processo_erogazione")
	private ProcessoErogazione processoErogazione;
	
	@Column(name="id_soggetto")
	private Integer idSoggetto; 
	
	@Enumerated(EnumType.STRING)
	@Column(nullable=false)
	private UnbundlingPratica unbundling = UnbundlingPratica.UNDEFINED;
	
	@Enumerated(EnumType.STRING)
	@Column(nullable=false)
	private FideiussionePratica fideiussione = FideiussionePratica.UNDEFINED;
	
	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_autorizzazione_contabile")
	private Date dataAutorizzazioneContabile;
	
	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_autorizzazione_legale")
	private Date dataAutorizzazioneLegale;
	
	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_fideiussione")
	private Date dataFideiussione;
	
	@Temporal(TemporalType.TIMESTAMP)
	@Column(name="data_unbundling")
	private Date dataUnbundling;
	
	public PraticaErogazione() {
	}

	public Integer getAnno() {
		return this.anno;
	}

	public void setAnno(Integer anno) {
		this.anno = anno;
	}

	public String getAutorizzazioneAutorizzante() {
		return this.autorizzazioneAutorizzante;
	}

	public void setAutorizzazioneAutorizzante(String autorizzazioneAutorizzante) {
		this.autorizzazioneAutorizzante = autorizzazioneAutorizzante;
	}

	public AutorizzazioneComitato getAutorizzazioneComitato() {
		return this.autorizzazioneComitato;
	}

	public void setAutorizzazioneComitato(AutorizzazioneComitato autorizzazioneComitato) {
		this.autorizzazioneComitato = autorizzazioneComitato;
	}

	public AutorizzazioneContabile getAutorizzazioneContabile() {
		return this.autorizzazioneContabile;
	}

	public void setAutorizzazioneContabile(AutorizzazioneContabile autorizzazioneContabile) {
		this.autorizzazioneContabile = autorizzazioneContabile;
	}

	public AutorizzazioneLegale getAutorizzazioneLegale() {
		return this.autorizzazioneLegale;
	}

	public void setAutorizzazioneLegale(AutorizzazioneLegale autorizzazioneLegale) {
		this.autorizzazioneLegale = autorizzazioneLegale;
	}

	public String getBimestre() {
		return this.bimestre;
	}

	public void setBimestre(String bimestre) {
		this.bimestre = bimestre;
	}

	public String getCodicePratica() {
		return this.codicePratica;
	}

	public void setCodicePratica(String codicePratica) {
		this.codicePratica = codicePratica;
	}

	public Date getDataAutorizzazioneComitato() {
		return this.dataAutorizzazioneComitato;
	}

	public void setDataAutorizzazioneComitato(Date dataAutorizzazioneComitato) {
		this.dataAutorizzazioneComitato = dataAutorizzazioneComitato;
	}

	public Date getDataContabilizzazione() {
		return this.dataContabilizzazione;
	}

	public void setDataContabilizzazione(Date dataContabilizzazione) {
		this.dataContabilizzazione = dataContabilizzazione;
	}

	public Date getDataErogazione() {
		return this.dataErogazione;
	}

	public void setDataErogazione(Date dataErogazione) {
		this.dataErogazione = dataErogazione;
	}

	public Date getDataInteressi() {
		return this.dataInteressi;
	}

	public void setDataInteressi(Date dataInteressi) {
		this.dataInteressi = dataInteressi;
	}

	public Date getDataLavorazione() {
		return this.dataLavorazione;
	}

	public void setDataLavorazione(Date dataLavorazione) {
		this.dataLavorazione = dataLavorazione;
	}

	@Deprecated
	public Date getDataRegolazione() {
		return this.dataRegolazione;
	}

	@Deprecated
	public void setDataRegolazione(Date dataRegolazione) {
		this.dataRegolazione = dataRegolazione;
	}

	public String getDescrizione() {
		return this.descrizione;
	}

	public void setDescrizione(String descrizione) {
		this.descrizione = descrizione;
	}

	public BigInteger getIdArticoloAc() {
		return this.idArticoloAc;
	}

	public void setIdArticoloAc(BigInteger idArticoloAc) {
		this.idArticoloAc = idArticoloAc;
	}

	public String getIdAutorizzante() {
		return this.idAutorizzante;
	}

	public void setIdAutorizzante(String idAutorizzante) {
		this.idAutorizzante = idAutorizzante;
	}

	public BigInteger getIdCapitoloAc() {
		return this.idCapitoloAc;
	}

	public void setIdCapitoloAc(BigInteger idCapitoloAc) {
		this.idCapitoloAc = idCapitoloAc;
	}

	public String getIdCentroCosto() {
		return this.idCentroCosto;
	}

	public void setIdCentroCosto(String idCentroCosto) {
		this.idCentroCosto = idCentroCosto;
	}

	public String getIdCentroResponsabilita() {
		return this.idCentroResponsabilita;
	}

	public void setIdCentroResponsabilita(String idCentroResponsabilita) {
		this.idCentroResponsabilita = idCentroResponsabilita;
	}

	public BigInteger getIdComponenteTariffariaAc() {
		return this.idComponenteTariffariaAc;
	}

	public void setIdComponenteTariffariaAc(BigInteger idComponenteTariffariaAc) {
		this.idComponenteTariffariaAc = idComponenteTariffariaAc;
	}

	public BigInteger getIdContoCorrenteAc() {
		return this.idContoCorrenteAc;
	}

	public void setIdContoCorrenteAc(BigInteger idContoCorrenteAc) {
		this.idContoCorrenteAc = idContoCorrenteAc;
	}

	public BigInteger getIdContoGestioneAc() {
		return this.idContoGestioneAc;
	}

	public void setIdContoGestioneAc(BigInteger idContoGestioneAc) {
		this.idContoGestioneAc = idContoGestioneAc;
	}

	public String getIdLavorante() {
		return this.idLavorante;
	}

	public void setIdLavorante(String idLavorante) {
		this.idLavorante = idLavorante;
	}

	public BigInteger getIdPosizioneFinanziariaAc() {
		return this.idPosizioneFinanziariaAc;
	}

	public void setIdPosizioneFinanziariaAc(BigInteger idPosizioneFinanziariaAc) {
		this.idPosizioneFinanziariaAc = idPosizioneFinanziariaAc;
	}

	public Integer getIdPraticaErogazioneDifferenza() {
		return this.idPraticaErogazioneDifferenza;
	}

	public void setIdPraticaErogazioneDifferenza(Integer idPraticaErogazioneDifferenza) {
		this.idPraticaErogazioneDifferenza = idPraticaErogazioneDifferenza;
	}

	public Integer getIdPraticaErogazioneOriginale() {
		return this.idPraticaErogazioneOriginale;
	}

	public void setIdPraticaErogazioneOriginale(Integer idPraticaErogazioneOriginale) {
		this.idPraticaErogazioneOriginale = idPraticaErogazioneOriginale;
	}

	public Integer getIdPraticaErogazioneRettifica() {
		return this.idPraticaErogazioneRettifica;
	}

	public void setIdPraticaErogazioneRettifica(Integer idPraticaErogazioneRettifica) {
		this.idPraticaErogazioneRettifica = idPraticaErogazioneRettifica;
	}

	public String getIdProponente() {
		return this.idProponente;
	}

	public void setIdProponente(String idProponente) {
		this.idProponente = idProponente;
	}



	public BigDecimal getImpegno() {
		return this.impegno;
	}

	public void setImpegno(BigDecimal impegno) {
		this.impegno = impegno;
	}

	public StatoPratica getLavorazioneContabile() {
		return this.lavorazioneContabile;
	}

	public void setLavorazioneContabile(StatoPratica lavorazioneContabile) {
		this.lavorazioneContabile = lavorazioneContabile;
	}

	public BigDecimal getMandato() {
		return this.mandato;
	}

	public void setMandato(BigDecimal mandato) {
		this.mandato = mandato;
	}

	public Integer getNumeroRettifica() {
		return this.numeroRettifica;
	}

	public void setNumeroRettifica(Integer numeroRettifica) {
		this.numeroRettifica = numeroRettifica;
	}

	public Integer getPeriodo() {
		return this.periodo;
	}

	public void setPeriodo(Integer periodo) {
		this.periodo = periodo;
	}

	public String getStatoPraticaGestionale() {
		return this.statoPraticaGestionale;
	}

	public void setStatoPraticaGestionale(String statoPraticaGestionale) {
		this.statoPraticaGestionale = statoPraticaGestionale;
	}

	public String getStatoRiepilogativo() {
		return this.statoRiepilogativo;
	}

	public void setStatoRiepilogativo(String statoRiepilogativo) {
		this.statoRiepilogativo = statoRiepilogativo;
	}

	public String getTipologia() {
		return this.tipologia;
	}

	public void setTipologia(String tipologia) {
		this.tipologia = tipologia;
	}

	public String getVistoConformita() {
		return this.vistoConformita;
	}

	public void setVistoConformita(String vistoConformita) {
		this.vistoConformita = vistoConformita;
	}

	public TipoPeriodo getTipoPeriodo() {
		return this.tipoPeriodo;
	}

	public void setTipoPeriodo(TipoPeriodo tipoPeriodo) {
		this.tipoPeriodo = tipoPeriodo;
	}

	public String getOwner() {
		return this.owner;
	}

	public void setOwner(String owner) {
		this.owner = owner;
	}

	public ProcessoErogazione getProcessoErogazione() {
		return this.processoErogazione;
	}

	public void setProcessoErogazione(ProcessoErogazione processoErogazione) {
		this.processoErogazione = processoErogazione;
	}
	
	public ProcessoErogazione getNota(){
		return processoErogazione;
	}
	
	public static enum AutorizzazioneComitato {
		UNDEFINED,DONT_CARE,AUTORIZZATO,NON_AUTORIZZATO,IN_LAVORAZIONE,RINVIATA
	}
	
	public static enum AutorizzazioneContabile {
		UNDEFINED,DONT_CARE,AUTORIZZATO,NON_AUTORIZZATO,IN_LAVORAZIONE
	}

	public static enum AutorizzazioneLegale {
		UNDEFINED,AUTORIZZATO,DONT_CARE,DEROGA_SOGLIA,DEROGA_CAM,DEROGA_123,NON_AUTORIZZATO,DI_UFFICIO,CAM_SCADUTA,IN_LAVORAZIONE,TEMPORANEA
	}
	
	public static enum StatoPratica {
		UNDEFINED,IN_INSERIMENTO,ASSEGNATO,LAVORABILE,LAVORATO,IN_SOSPESO,IN_EROGAZIONE,RISCONTRATO,ANNULLATO,DONT_CARE
	}
	
	public static enum UnbundlingPratica{
		UNDEFINED,AUTORIZZATO,NON_AUTORIZZATO,DONT_CARE
	}
	
	public static enum FideiussionePratica{
		UNDEFINED, PRESENTE, ASSENTE, DONT_CARE;
	}

	
	public Integer getIdPraticaErogazione(){
		return getId();
	}
	
	public void setIdPraticaErogazione(Integer id){
		setId(id);
	}
	
	/* (non-Javadoc)
	 * @see java.lang.Object#toString()
	 */
	@Override
	public String toString() {
		StringBuilder builder = new StringBuilder();
		builder.append("PraticaErogazione [anno=");
		builder.append(anno);
		builder.append(", autorizzazioneAutorizzante=");
		builder.append(autorizzazioneAutorizzante);
		builder.append(", autorizzazioneComitato=");
		builder.append(autorizzazioneComitato);
		builder.append(", autorizzazioneContabile=");
		builder.append(autorizzazioneContabile);
		builder.append(", autorizzazioneLegale=");
		builder.append(autorizzazioneLegale);
		builder.append(", bimestre=");
		builder.append(bimestre);
		builder.append(", codicePratica=");
		builder.append(codicePratica);
		builder.append(", dataAutorizzazioneComitato=");
		builder.append(dataAutorizzazioneComitato);
		builder.append(", dataContabilizzazione=");
		builder.append(dataContabilizzazione);
		builder.append(", dataErogazione=");
		builder.append(dataErogazione);
		builder.append(", dataInteressi=");
		builder.append(dataInteressi);
		builder.append(", dataLavorazione=");
		builder.append(dataLavorazione);
		builder.append(", dataScadenza=");
		builder.append(dataScadenza);
		builder.append(", dataCompetenzaEconomica=");
		builder.append(dataCompetenzaEconomica);
		builder.append(", descrizione=");
		builder.append(descrizione);
		builder.append(", idArticoloAc=");
		builder.append(idArticoloAc);
		builder.append(", idCapitoloAc=");
		builder.append(idCapitoloAc);
		builder.append(", idComponenteTariffariaAc=");
		builder.append(idComponenteTariffariaAc);
		builder.append(", idContoCorrenteAc=");
		builder.append(idContoCorrenteAc);
		builder.append(", idContoGestioneAc=");
		builder.append(idContoGestioneAc);
		builder.append(", idLavorante=");
		builder.append(idLavorante);
		builder.append(", idPosizioneFinanziariaAc=");
		builder.append(idPosizioneFinanziariaAc);
		builder.append(", settoreAttivita=");
		builder.append(settoreAttivita);
		builder.append(", impegno=");
		builder.append(impegno);
		builder.append(", lavorazioneContabile=");
		builder.append(lavorazioneContabile);
		builder.append(", mandato=");
		builder.append(mandato);
		builder.append(", numeroRettifica=");
		builder.append(numeroRettifica);
		builder.append(", periodo=");
		builder.append(periodo);
		builder.append(", tipologia=");
		builder.append(tipologia);
		builder.append(", tipoPeriodo=");
		builder.append(tipoPeriodo);
		builder.append(", owner=");
		builder.append(owner);
		builder.append(", processoErogazione=");
		builder.append(processoErogazione!=null?processoErogazione.getId():null);
		builder.append(", idSoggetto=");
		builder.append(idSoggetto);
		builder.append(", unbundling=");
		builder.append(unbundling);
		builder.append(", fideiussione=");
		builder.append(fideiussione);
		builder.append(", dataAutorizzazioneContabile=");
		builder.append(dataAutorizzazioneContabile);
		builder.append(", dataAutorizzazioneLegale=");
		builder.append(dataAutorizzazioneLegale);
		builder.append(", dataFideiussione=");
		builder.append(dataFideiussione);
		builder.append(", dataUnbundling=");
		builder.append(dataUnbundling);
		builder.append("]");
		return builder.toString();
	}
	
	public ProcessoErogazione associaANota(ProcessoErogazione processo){
		checkAssociaANota();
		processoErogazione = processo;
		lavorazioneContabile = StatoPratica.ASSEGNATO;
		return processo;
	}
	
	
	
	public void checkAssociaANota(){
		if(lavorazioneContabile!=StatoPratica.IN_INSERIMENTO){
			throw new ApplicationException("error.pratica.statoContabile.invalid.associazionePraticaNota");
		}
	}

	public void checkDissociaDaNota(){
		if(lavorazioneContabile!=StatoPratica.ASSEGNATO){
			throw new ApplicationException("error.pratica.statoContabile.invalid.dissociazionePraticaNotaNota");
		}
	}
	
	public void checkModificabilita() {
		switch(getLavorazioneContabile()){
		case IN_EROGAZIONE:
		case IN_SOSPESO:
		case LAVORATO:
		case RISCONTRATO:
		case UNDEFINED:
			throw new ApplicationException("error.pratica.statoContabile.invalid.modifica");
		default:
			break;
		}
	}

	public void dissociaDaNota() {
		checkDissociaDaNota();
		processoErogazione = null;	
		lavorazioneContabile = StatoPratica.IN_INSERIMENTO;
	}

	public void init() {
		setId(null);
		lavorazioneContabile = StatoPratica.IN_INSERIMENTO;
		autorizzazioneComitato = AutorizzazioneComitato.UNDEFINED;
		autorizzazioneContabile = AutorizzazioneContabile.UNDEFINED;
		if(periodo==null){periodo = 0;}
		
		if (getSettoreAttivita()!=null){	
			this.aggiornaAntimafia(this.getSettoreAttivita().getStatoAntimafia());
			this.aggiornaUnbundling(this.getSettoreAttivita().getUnbundling());
			this.aggiornaFideiussione(FideiussionePratica.ASSENTE);
		}
	}

	public void checkInit() {
		if(lavorazioneContabile!=null&&lavorazioneContabile != StatoPratica.UNDEFINED){
			throw new ApplicationException("error.pratica.statoContabile.invalid.inserimento");		
		}
	}

	/**
	 * @return the unbundling
	 */
	public UnbundlingPratica getUnbundling() {
		return unbundling;
	}

	/**
	 * @param unbundling the unbundling to set
	 */
	public void setUnbundling(UnbundlingPratica unbundling) {
		this.unbundling = unbundling;
	}

	/**
	 * @return the fideiussione
	 */
	public FideiussionePratica getFideiussione() {
		return fideiussione;
	}

	/**
	 * @param fideiussione the fideiussione to set
	 */
	public void setFideiussione(FideiussionePratica fideiussione) {
		this.fideiussione = fideiussione;
	}

	
	

	public void autorizzaComitato(){
		checkGestioneComitato();
		if(autorizzazioneComitato != AutorizzazioneComitato.AUTORIZZATO){
			dataAutorizzazioneComitato = new Date();
			autorizzazioneComitato = AutorizzazioneComitato.AUTORIZZATO;
		}
		lavorazioneContabile = StatoPratica.LAVORABILE;
	}
	
	public void checkGestioneComitato() {
		switch(lavorazioneContabile){
		case LAVORABILE:
			break;
		case ANNULLATO:
		case DONT_CARE:
		case IN_EROGAZIONE:
		case IN_INSERIMENTO:
		case IN_SOSPESO:
		case LAVORATO:	
		case RISCONTRATO:
		case UNDEFINED:
			throw new ApplicationException("error.pratica.statoContabile.invalid.gestioneComitato");
		default:
			break;
		}
		
	}

	public void rifiutaAutorizzazioneComitato(){
		checkGestioneComitato();
		if(autorizzazioneComitato != AutorizzazioneComitato.NON_AUTORIZZATO){
			dataAutorizzazioneComitato = new Date();
		}
		autorizzazioneComitato = AutorizzazioneComitato.NON_AUTORIZZATO;
		lavorazioneContabile = StatoPratica.LAVORABILE;
	}

	public boolean hasBloccoContabile(){
		switch(autorizzazioneContabile){
		case AUTORIZZATO:
		case DONT_CARE:
			return false;
		default: 
			return true;			
		}
	}
	
	public boolean hasBloccoComitato(){
		switch(autorizzazioneComitato){
		case AUTORIZZATO:
		case DONT_CARE:
			return false;
		default:
			return true;
		}
	}
	
	public boolean hasBloccoLegale(){
		switch (autorizzazioneLegale){
		case AUTORIZZATO:
		case DEROGA_123:
		case DEROGA_CAM:
		case DEROGA_SOGLIA:
		case DONT_CARE:
		case TEMPORANEA:
			return false;
		default:
			return true;
		}
	}
	
	public boolean hasBloccoFideiussione(){
		switch(fideiussione){
		case DONT_CARE:
		case PRESENTE:
			return false;
		default:
			return true;
		}
	}
	
	public boolean hasBloccoUnbundling(){
		switch (unbundling){
		case AUTORIZZATO:
		case DONT_CARE:
			return false;
		default:
			return true;
			
		}
	}
	
	public boolean isSbloccata(){
		return  !(hasBloccoComitato()||hasBloccoContabile()||hasBloccoFideiussione()||hasBloccoLegale()||hasBloccoUnbundling());
	}
	
	public boolean isErogabile(){
		return isSbloccata() && !hasBloccoDataScadenza();
	}
	
	public boolean hasBloccoDataScadenza(){
		Date dataRif = dataScadenza!=null ? dataScadenza : dataInteressi;
		return dataRif !=null && dataRif.after(DateUtils.addDays(new Date(), UsciteProperties.SOGLIA_GIORNI_SBLOCCO_DATA_REGOLAZIONE));
	}
	
	public void lavorazioneContabile() {
		checkLavorazioneContabile();
		if(!isErogabile()){
			lavorazioneContabile = StatoPratica.IN_SOSPESO;
		}else{
			lavorazioneContabile = StatoPratica.IN_EROGAZIONE;
			mandato = impegno;
		}
		if(dataContabilizzazione == null){ 
			dataContabilizzazione = new Date();
		}
	}

	public void checkLavorazioneContabile() {
		if(lavorazioneContabile != StatoPratica.LAVORATO &&
		   lavorazioneContabile != StatoPratica.IN_SOSPESO && 
		   lavorazioneContabile != StatoPratica.LAVORABILE
		){
			throw new ApplicationException("error.pratica.statoContabile.invalid.lavorazione");
		}
		if(this.autorizzazioneComitato == AutorizzazioneComitato.UNDEFINED){
			throw new ApplicationException("error.pratica.autorizzazioneComitato.invalid.lavorazione");
		}
	}

	public AutorizzazioneLegale aggiornaAntimafia(StatoAntimafia statoAntimafia) {
		if(statoAntimafia!=null){
			boolean hadBloccoLegale = hasBloccoLegale();
			switch(statoAntimafia){
			case BLOCCATO:
				autorizzazioneLegale = AutorizzazioneLegale.NON_AUTORIZZATO;
				break;
			case CERTIFICATO_VALIDO:
				autorizzazioneLegale = AutorizzazioneLegale.AUTORIZZATO;
				break;
			case MUNICIPALIZZATA:
				autorizzazioneLegale = AutorizzazioneLegale.DEROGA_CAM;
				break;
			case PAGAMENTO_SOTTO_CONDIZIONE:
				autorizzazioneLegale = AutorizzazioneLegale.DEROGA_123;
				break;
			case SOTTOSOGLIA:
				autorizzazioneLegale = AutorizzazioneLegale.DEROGA_SOGLIA;
				break;
			default:
				break;
			}
			if(hadBloccoLegale!=hasBloccoLegale() || dataAutorizzazioneLegale == null){
				dataAutorizzazioneLegale = new Date();
			}			
		}
		return autorizzazioneLegale;
	}

	public UnbundlingPratica aggiornaUnbundling(SettoreAttivita.Unbundling unbundlingSocieta) {
		if(unbundlingSocieta!=null){
			boolean hadBloccoUnbundling = hasBloccoUnbundling();
			if(UsciteProperties.LISTA_COMPONENTI_TARIFFARIE_SOGGETTE_BLOCCO_UNBUNDLING.contains(idComponenteTariffariaAc.toString())){
				switch(unbundlingSocieta){
				case BLOCCATA:
					unbundling = UnbundlingPratica.NON_AUTORIZZATO;
					break;
				case SBLOCCATA:
					unbundling = UnbundlingPratica.AUTORIZZATO;
					break;
				default:
					break;
				}
			}else{
				unbundling = UnbundlingPratica.DONT_CARE;
			}
			if(hadBloccoUnbundling != hasBloccoUnbundling() || dataUnbundling == null){
				dataUnbundling = new Date();
			}
		}
		return unbundling;
	}

	public FideiussionePratica aggiornaFideiussione(FideiussionePratica nuovaFideiussione) {
			boolean hadBloccoFideiussione = hasBloccoFideiussione();
			if(UsciteProperties.LISTA_COMPONENTI_TARIFFARIE_FIDEIUSSIONE.contains(idComponenteTariffariaAc.toString())){
				switch(nuovaFideiussione){
				case ASSENTE:
					fideiussione = FideiussionePratica.ASSENTE;
					break;
				case PRESENTE:
					fideiussione = FideiussionePratica.PRESENTE;
					break;
				case UNDEFINED:
					fideiussione = FideiussionePratica.UNDEFINED;
					break;
				default:
					break;
				}
			}else{
				fideiussione = FideiussionePratica.DONT_CARE;
			}
			if(hadBloccoFideiussione != hasBloccoFideiussione() || dataFideiussione == null){
				dataFideiussione = new Date();
			}
		
		return fideiussione;
	}

	private Date calcolaDataErogabilita(){
		Date dataErogabilita = null;
		if(isSbloccata()){
			List<Date> dateSblocco = new ArrayList<Date>();
			if(dataAutorizzazioneContabile!=null){
				dateSblocco.add(dataAutorizzazioneContabile);
			}
			if(dataAutorizzazioneLegale!=null){
				dateSblocco.add(dataAutorizzazioneLegale);
			}
			if(dataAutorizzazioneComitato!=null){
				dateSblocco.add(dataAutorizzazioneComitato);
			}
			if(dataUnbundling!=null){
				dateSblocco.add(dataUnbundling);
			}
			if(dataFideiussione!=null){
				dateSblocco.add(dataFideiussione);
			}
			Date dataRif = dataScadenza!=null ? dataScadenza : dataInteressi;
			if(dataRif!=null){
				dateSblocco.add(DateUtils.addDays(dataRif, -UsciteProperties.SOGLIA_GIORNI_SBLOCCO_DATA_REGOLAZIONE));
			}
			if(!dateSblocco.isEmpty()){
				dataErogabilita = Collections.max(dateSblocco);
			}
		}
		return dataErogabilita;
	}
	
	/**
	 * @return the settoreAttivita
	 */
	public SettoreAttivita getSettoreAttivita() {
		return settoreAttivita;
	}

	/**
	 * @param settoreAttivita the settoreAttivita to set
	 */
	public void setSettoreAttivita(SettoreAttivita settoreAttivita) {
		this.settoreAttivita = settoreAttivita;
	}

	/**
	 * @return the idSoggetto
	 */
	public Integer getIdSoggetto() {
		return idSoggetto;
	}

	/**
	 * @param idSoggetto the idSoggetto to set
	 */
	public void setIdSoggetto(Integer idSoggetto) {
		this.idSoggetto = idSoggetto;
	}

	public void rinvia(ProcessoErogazione processo){
		checkModificabilita();
		processo.getOrdineDelGiorno().checkRinvioComitato();
		autorizzazioneComitato = AutorizzazioneComitato.RINVIATA;
		processoErogazione = processo;
	}
	
	
	public Integer getIdSettoreAttivita(){
		return settoreAttivita!=null?settoreAttivita.getId():null;
	}

	public Date getDataAutorizzazioneContabile() {
		return dataAutorizzazioneContabile;
	}

	public void setDataAutorizzazioneContabile(Date dataAutorizzazioneContabile) {
		this.dataAutorizzazioneContabile = dataAutorizzazioneContabile;
	}

	public Date getDataAutorizzazioneLegale() {
		return dataAutorizzazioneLegale;
	}

	public void setDataAutorizzazioneLegale(Date dataAutorizzazioneLegale) {
		this.dataAutorizzazioneLegale = dataAutorizzazioneLegale;
	}

	public Date getDataFideiussione() {
		return dataFideiussione;
	}

	public void setDataFideiussione(Date dataFideiussione) {
		this.dataFideiussione = dataFideiussione;
	}

	public Date getDataUnbundling() {
		return dataUnbundling;
	}

	public void setDataUnbundling(Date dataUnbundling) {
		this.dataUnbundling = dataUnbundling;
	}

	public Date getDataInErogazione() {
		return getDataErogabilita();
	}

	
	public Date getDataErogabilita() {
		return calcolaDataErogabilita();
	}

	public void annullaAutorizzazioneComitato() {
		setAutorizzazioneComitato(AutorizzazioneComitato.UNDEFINED);
		setDataAutorizzazioneComitato(null);
	}

	public Date getDataScadenza() {
		return dataScadenza;
	}

	public void setDataScadenza(Date dataScadenza) {
		this.dataScadenza = dataScadenza;
	}

	public Date getDataCompetenzaEconomica() {
		return dataCompetenzaEconomica;
	}

	public void setDataCompetenzaEconomica(Date dataCompetenzaEconomica) {
		this.dataCompetenzaEconomica = dataCompetenzaEconomica;
	}

	public String getCodicePosizioneFinanziaria() {
		return codicePosizioneFinanziaria;
	}

	public void setCodicePosizioneFinanziaria(String codicePosizioneFinanziaria) {
		this.codicePosizioneFinanziaria = codicePosizioneFinanziaria;
	}

	
}